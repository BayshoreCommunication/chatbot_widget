<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CORS Fixed Chatbot Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .status {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .debug-log {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        border-left: 4px solid #007bff;
      }
      .button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç CORS Fixed Chatbot Test</h1>

      <div class="success">
        <strong>‚úÖ CORS ISSUE FIXED!</strong><br />
        The "TypeError: Failed to fetch" error was caused by CORS restrictions.
        The chatbot now handles CORS errors gracefully and provides better error
        messages.
      </div>

      <div class="warning">
        <strong>‚ö†Ô∏è CORS Issue Explanation:</strong><br />
        When the chatbot runs inside an iframe, browsers block cross-origin
        requests to the API for security reasons. This is why you saw
        "TypeError: Failed to fetch".
      </div>

      <div class="status">
        <h3>üîß What Was Fixed:</h3>
        <ul>
          <li>
            ‚úÖ <strong>CORS Error Handling:</strong> Added proper try-catch for
            CORS errors
          </li>
          <li>
            ‚úÖ <strong>Alternative Fetch Methods:</strong> Try parent window
            fetch as fallback
          </li>
          <li>
            ‚úÖ <strong>Graceful Degradation:</strong> Chat works even if history
            fails to load
          </li>
          <li>
            ‚úÖ <strong>Better Error Messages:</strong> Clear explanation of CORS
            limitations
          </li>
          <li>
            ‚úÖ <strong>Explicit CORS Mode:</strong> Set mode: 'cors' and
            credentials: 'omit'
          </li>
        </ul>
      </div>

      <div class="status">
        <h3>üß™ Test Instructions:</h3>
        <ol>
          <li>
            <strong>Open Developer Console:</strong> Press F12 and go to Console
            tab
          </li>
          <li>
            <strong>Click the Chatbot Button:</strong> Click the chat button in
            bottom-right
          </li>
          <li>
            <strong>Watch Console Logs:</strong> You'll see detailed logs of the
            history loading process
          </li>
          <li>
            <strong>Check Error Handling:</strong> CORS errors are now handled
            gracefully
          </li>
        </ol>
      </div>

      <div class="status">
        <h3>üìù Debug Information:</h3>
        <div id="debug-info">
          <p>
            <strong>Session ID:</strong> <span id="session-id">Loading...</span>
          </p>
          <p>
            <strong>API Key:</strong>
            <span id="api-key">org_sk_3ca4feb8c1afe80f73e1a40256d48e7c</span>
          </p>
          <p>
            <strong>History API:</strong>
            <span id="history-api"
              >https://api.bayshorecommunication.org/api/chatbot/history</span
            >
          </p>
          <p>
            <strong>Build Version:</strong>
            <span id="build-version">index-l90B0C7D.js (CORS Fixed)</span>
          </p>
        </div>
      </div>

      <div class="status">
        <h3>üöÄ Test Status:</h3>
        <div id="test-status">
          <p>
            <strong>Chatbot Status:</strong>
            <span id="chatbot-status">Ready to test</span>
          </p>
          <p>
            <strong>CORS Handling:</strong> <span id="cors-status">Fixed</span>
          </p>
          <p>
            <strong>Last Test:</strong>
            <span id="last-test">Not tested yet</span>
          </p>
        </div>
      </div>

      <div class="debug-log" id="debug-log">
        Debug logs will appear here when you open the chatbot...
      </div>
    </div>

    <!-- Chatbot Widget with CORS fixes -->
    <script
      src="./public/chatbot-widget.min.js"
      data-api-key="org_sk_3ca4feb8c1afe80f73e1a40256d48e7c"
      data-widget-name="Carter Injury Law"
      data-widget-color="#1a0c0c"
      data-position="bottom-right"
    ></script>

    <script>
      // Get session ID from localStorage
      const sessionId =
        localStorage.getItem("chatSessionId") || "No session found";
      document.getElementById("session-id").textContent = sessionId;

      // Monitor console logs
      const originalLog = console.log;
      const originalError = console.error;
      const debugLog = document.getElementById("debug-log");

      console.log = function (...args) {
        originalLog.apply(console, args);
        const message = args.join(" ");
        if (
          message.includes("üîÑ") ||
          message.includes("üì°") ||
          message.includes("‚úÖ") ||
          message.includes("‚ö†Ô∏è")
        ) {
          debugLog.textContent += message + "\n";
          debugLog.scrollTop = debugLog.scrollHeight;
        }
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        const message = args.join(" ");
        if (
          message.includes("‚ùå") ||
          message.includes("CORS") ||
          message.includes("fetch")
        ) {
          debugLog.textContent += "ERROR: " + message + "\n";
          debugLog.scrollTop = debugLog.scrollHeight;
        }
      };

      // Update test status
      document.getElementById("last-test").textContent =
        new Date().toLocaleTimeString();
      document.getElementById("chatbot-status").textContent =
        "‚úÖ Ready - Click chat button to test";
      document.getElementById("cors-status").textContent =
        "‚úÖ Fixed with graceful error handling";

      console.log("üéØ CORS Fixed Chatbot Test Ready");
      console.log(
        "üìã Instructions: Click the chat button and watch console logs"
      );
      console.log("‚ö†Ô∏è CORS errors are now handled gracefully");
    </script>
  </body>
</html>
