<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat History API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .status {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .test-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #007bff;
      }
      .api-response {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .session-info {
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Chat History API Test</h1>

      <div class="status">
        <h3>üìã Test Overview:</h3>
        <p>
          This test will check if your chat history API is working properly by:
        </p>
        <ul>
          <li>‚úÖ Testing the chat history endpoint</li>
          <li>‚úÖ Checking session ID management</li>
          <li>‚úÖ Verifying API response format</li>
          <li>‚úÖ Testing with your actual API key</li>
        </ul>
      </div>

      <div class="session-info">
        <h3>üîë Session Information:</h3>
        <p>
          <strong>Current Session ID:</strong>
          <span id="current-session">Loading...</span>
        </p>
        <p>
          <strong>API Key:</strong>
          <span id="api-key">org_sk_3ca4feb8c1afe80f73e1a40256d48e7c</span>
        </p>
        <p>
          <strong>History API URL:</strong>
          <span id="history-url"
            >https://api.bayshorecommunication.org/api/chatbot/history</span
          >
        </p>
      </div>

      <div class="test-section">
        <h3>üß™ API Tests:</h3>
        <button class="button" onclick="testHistoryAPI()">
          Test Chat History API
        </button>
        <button class="button" onclick="testSessionManagement()">
          Test Session Management
        </button>
        <button class="button" onclick="clearSessionData()">
          Clear Session Data
        </button>
        <button class="button" onclick="generateNewSession()">
          Generate New Session
        </button>
      </div>

      <div id="test-results">
        <!-- Test results will appear here -->
      </div>

      <div class="status">
        <h3>üìä Test Status:</h3>
        <div id="test-status">
          <p>
            <strong>API Status:</strong> <span id="api-status">Not tested</span>
          </p>
          <p>
            <strong>Session Status:</strong>
            <span id="session-status">Not tested</span>
          </p>
          <p><strong>Last Test:</strong> <span id="last-test">Never</span></p>
        </div>
      </div>

      <div class="status">
        <h3>üîß Debug Information:</h3>
        <div id="debug-info">
          <p>
            <strong>Local Storage:</strong>
            <span id="local-storage-info">Checking...</span>
          </p>
          <p>
            <strong>Browser Support:</strong>
            <span id="browser-support">Checking...</span>
          </p>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const API_KEY = "org_sk_3ca4feb8c1afe80f73e1a40256d48e7c";
      const HISTORY_API_URL =
        "https://api.bayshorecommunication.org/api/chatbot/history";

      // Session management
      let currentSessionId = null;

      // Initialize
      function initialize() {
        // Get current session ID
        currentSessionId =
          localStorage.getItem("chatSessionId") || generateUUID();
        localStorage.setItem("chatSessionId", currentSessionId);

        // Update UI
        document.getElementById("current-session").textContent =
          currentSessionId;
        document.getElementById("api-key").textContent = API_KEY;
        document.getElementById("history-url").textContent = HISTORY_API_URL;

        // Check browser support
        const hasLocalStorage = typeof Storage !== "undefined";
        const hasFetch = typeof fetch !== "undefined";
        document.getElementById(
          "browser-support"
        ).textContent = `LocalStorage: ${
          hasLocalStorage ? "‚úÖ" : "‚ùå"
        }, Fetch: ${hasFetch ? "‚úÖ" : "‚ùå"}`;

        // Check localStorage
        const sessionData = localStorage.getItem("chatSessionId");
        const visitData = localStorage.getItem("chatbot_has_visited");
        document.getElementById("local-storage-info").textContent = `Session: ${
          sessionData ? "‚úÖ" : "‚ùå"
        }, Visited: ${visitData ? "‚úÖ" : "‚ùå"}`;
      }

      // Generate UUID (simplified version)
      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
          /[xy]/g,
          function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c == "x" ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          }
        );
      }

      // Test chat history API
      async function testHistoryAPI() {
        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML =
          '<div class="status">üîÑ Testing Chat History API...</div>';

        try {
          const url = `${HISTORY_API_URL}/${currentSessionId}`;
          console.log("üîç Testing URL:", url);

          const response = await fetch(url, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": API_KEY,
            },
          });

          console.log("üì° Response status:", response.status);
          console.log("üì° Response headers:", response.headers);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("üì¶ Response data:", data);

          // Display results
          let resultHtml =
            '<div class="success">‚úÖ Chat History API Test Successful!</div>';
          resultHtml += '<div class="test-section">';
          resultHtml += "<h4>üì¶ API Response:</h4>";
          resultHtml += `<div class="api-response">${JSON.stringify(
            data,
            null,
            2
          )}</div>`;
          resultHtml += "</div>";

          // Analyze response
          if (data.user_data && data.user_data.conversation_history) {
            const historyCount = data.user_data.conversation_history.length;
            resultHtml += `<div class="status">üìä Found ${historyCount} messages in conversation history</div>`;

            if (historyCount > 0) {
              resultHtml += '<div class="test-section">';
              resultHtml += "<h4>üí¨ Recent Messages:</h4>";
              data.user_data.conversation_history
                .slice(-3)
                .forEach((msg, index) => {
                  resultHtml += `<div class="api-response">Message ${
                    index + 1
                  }: ${msg.role} - ${msg.content.substring(0, 100)}${
                    msg.content.length > 100 ? "..." : ""
                  }</div>`;
                });
              resultHtml += "</div>";
            }
          } else {
            resultHtml +=
              '<div class="warning">‚ö†Ô∏è No conversation history found for this session</div>';
          }

          resultsDiv.innerHTML = resultHtml;

          // Update status
          document.getElementById("api-status").textContent = "‚úÖ Working";
          document.getElementById("last-test").textContent =
            new Date().toLocaleTimeString();
        } catch (error) {
          console.error("‚ùå API Test Error:", error);

          let errorHtml =
            '<div class="error">‚ùå Chat History API Test Failed!</div>';
          errorHtml += '<div class="test-section">';
          errorHtml += "<h4>üö® Error Details:</h4>";
          errorHtml += `<div class="api-response">${error.message}</div>`;
          errorHtml += "</div>";

          resultsDiv.innerHTML = errorHtml;

          // Update status
          document.getElementById("api-status").textContent = "‚ùå Failed";
          document.getElementById("last-test").textContent =
            new Date().toLocaleTimeString();
        }
      }

      // Test session management
      function testSessionManagement() {
        const resultsDiv = document.getElementById("test-results");

        let resultHtml =
          '<div class="status">üîÑ Testing Session Management...</div>';

        // Test localStorage
        const storedSession = localStorage.getItem("chatSessionId");
        const hasVisited = localStorage.getItem("chatbot_has_visited");

        resultHtml += '<div class="test-section">';
        resultHtml += "<h4>üîë Session Management Test:</h4>";
        resultHtml += `<div class="api-response">Current Session ID: ${currentSessionId}
Stored Session ID: ${storedSession || "None"}
Session Match: ${storedSession === currentSessionId ? "‚úÖ" : "‚ùå"}
Has Visited: ${hasVisited ? "‚úÖ" : "‚ùå"}</div>`;
        resultHtml += "</div>";

        if (storedSession === currentSessionId) {
          resultHtml +=
            '<div class="success">‚úÖ Session Management Working Correctly!</div>';
          document.getElementById("session-status").textContent = "‚úÖ Working";
        } else {
          resultHtml +=
            '<div class="error">‚ùå Session Management Issue Detected!</div>';
          document.getElementById("session-status").textContent = "‚ùå Failed";
        }

        resultsDiv.innerHTML = resultHtml;
        document.getElementById("last-test").textContent =
          new Date().toLocaleTimeString();
      }

      // Clear session data
      function clearSessionData() {
        localStorage.removeItem("chatSessionId");
        localStorage.removeItem("chatbot_has_visited");

        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML =
          '<div class="success">‚úÖ Session data cleared! Refresh the page to generate a new session.</div>';

        // Update UI
        document.getElementById("local-storage-info").textContent =
          "Session: ‚ùå, Visited: ‚ùå";
      }

      // Generate new session
      function generateNewSession() {
        currentSessionId = generateUUID();
        localStorage.setItem("chatSessionId", currentSessionId);

        const resultsDiv = document.getElementById("test-results");
        resultsDiv.innerHTML =
          '<div class="success">‚úÖ New session generated!</div>';

        // Update UI
        document.getElementById("current-session").textContent =
          currentSessionId;
        document.getElementById("local-storage-info").textContent =
          "Session: ‚úÖ, Visited: ‚úÖ";
      }

      // Initialize on page load
      initialize();

      // Auto-test on load
      setTimeout(() => {
        testHistoryAPI();
      }, 1000);
    </script>
  </body>
</html>
